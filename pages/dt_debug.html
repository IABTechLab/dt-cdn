<!DOCTYPE html>
<html>
<head>

    <!--
        add this for debug
        configGeneral.urls.digitrustIdService = "../misc/faked_id_service_v1.json" //http://local.digitru.st/misc/faked_id_service_v1.json
        <script src='./digitrust.js'></script>
    -->

    <title>DigiTrust Debug Server IFrame</title>
    <meta charset="utf-8">
    <script src='./digitrust.js'></script>
    <script>
        // Place initializer inside a closure

        (function () {
            'use strict'
            // ATTACH GLOBAL ERROR HANDLER
            try {
                var errGlobal = function (err) {
                    var m = err && err.message || '';
                    var errMsg = "Digitrust frame error: " + m;
                    try {
                        
                        if (console && console.error) {
                            console.error(errMsg);
                        }
                        else {
                            console.log(errMsg);
                        }
                        console.trace();

                        var eobj = {
                            version: 1,
                            type: 'DigiTrust.iframe.error',
                            value: {}
                        }
                        window.parent.postMessage(eobj, document.referrer);
                    }
                    catch (myex) {
                        console.log(myex);
                    }
                }
                window.addEventListener('error', errGlobal)
            }
            catch (ex) {
                // swallow this particular error
            }


            var dt = window.DigiTrust;
            var configGeneral = dt._config.configGeneral;
            configGeneral.urls.digitrustIdService = "../misc/faked_id_service_v1.json" //http://local.digitru.st/misc/faked_id_service_v1.json
            var DigiTrustCookie = dt.cookie;
            var DigiTrustCrypto = dt._config.crypto;
            var helpers = dt.util;
            var cookieKey = "DigiTrust.v1.identity";
            var cookieName = {
                reset: 'DeleteEverything',
                userObject: cookieKey
            }
            // var DigiTrustCrypto = dt._config.crypto;

            var m = DigiTrustCrypto.getKeyVersion();

            function messageHandler(evt) {
                switch (evt.data.type) {
                    case 'DigiTrust.identity.request':
                        var userObj = DigiTrustCookie.getUserIdentity();
                        var isOptOut = DigiTrustCookie.getOptOut();


                        var sendMessage = function (value) {
                            var messageType = evt.data.syncOnly ?
                                'DigiTrust.identity.response.syncOnly' :
                                'DigiTrust.identity.response';
                            var identity = {
                                version: 1,
                                type: messageType,
                                value: value
                            };
                            window.parent.postMessage(identity, evt.origin);
                        }

                        if ((!isOptOut) && (helpers.isEmpty(userObj))) {
                            // see if we can write and read cookies from within the iframe
                            DigiTrustCookie.createUserCookiesOnDigitrustDomain();
                            userObj = DigiTrustCookie.getUserIdentity(cookieKey);
                        }
                        if (userObj.hasOwnProperty('id')) {
                            try {
                                DigiTrustCrypto.encrypt(userObj.id, function (encryptedUserId) {
                                    userObj.id = encryptedUserId;
                                    userObj.keyv = DigiTrustCrypto.getKeyVersion();
                                    sendMessage(userObj);
                                });
                            } catch (e) {
                                sendMessage({ "error": true });
                            }
                        } else {
                            sendMessage(userObj);
                        }
                        break;
                    case 'DigiTrust.identity.reset':
                        var DE = DigiTrustCookie.getCookieByName(cookieName.reset); // configGeneral.cookie.digitrust.resetKey
                        if (DE === 'true') {
                            DigiTrustCookie.expireCookie(cookieName.reset);
                            DigiTrustCookie.expireCookie(cookieName.userObject);
                        }
                        break;
                }
            }


            if (window.addEventListener) {
                window.addEventListener('message', messageHandler, false);
            } else {
                window.attachEvent('onmessage', messageHandler);
            }

            // Iframe JavaScript is loaded, send READY message to parent
            var iframeReady = {
                version: 1,
                type: 'DigiTrust.iframe.ready',
                value: {}
            };
            window.parent.postMessage(iframeReady, document.referrer);
        })();

    </script>
</head>
<body>
    <script>

        /* SCRIPT CONTENTS HERE */

    </script>
</body>
</html>
