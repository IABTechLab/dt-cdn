<!DOCTYPE html>
<html>
<head>
    <script src='./digitrust-server.js'></script>
    <link rel="P3Pv1" href="http://digitrust.s3.amazonaws.com/dev/v1/p3p.xml">
    <script>

        var cookieKey = configGeneral.cookie.publisher.userObjectKey;
        var userJSON = DigiTrustCookie.getIdentityCookieJSON(cookieKey);

        function messageHandler(evt) {
            switch (evt.data.type) {
                case 'DigiTrust.identity.request':
                    var digiTrustUserCookie = DigiTrustCookie.getCookieByName(configGeneral.cookie.digitrust.userObjectKey);
                    var digiTrustUserJSON = digiTrustUserCookie ?
                        DigiTrustCookie.unobfuscateCookieValue(digiTrustUserCookie) : {};

                    var messageType = evt.data.syncOnly ?
                        'DigiTrust.identity.response.syncOnly' :
                        'DigiTrust.identity.response';
                    var identity = {
                        version: 1,
                        type: messageType,
                        value: digiTrustUserJSON
                    };
                    window.parent.postMessage(identity, evt.origin);
                    break;
                case 'DigiTrust.getAppsPreferences.request':
                    var appData = DigiTrustAppContainer.server.getAppForMember(evt.data.value.member);
                    var identity = {
                        version: 1,
                        type: 'DigiTrust.getAppsPreferences.response',
                        value: appData
                    };
                    window.parent.postMessage(identity, evt.origin);
                    break;
                case 'DigiTrust.setAppsPreferences.request':
                    var success;
                    if (DigiTrustAppContainer.server.setAppForMember(evt.data.value.member, evt.data.value.app)) {
                        success = true;
                    } else {
                        success = false;
                    }
                    var identity = {
                        version: 1,
                        type: 'DigiTrust.setAppsPreferences.response',
                        value: {
                            success: success,
                            app: evt.data.value.app
                        }
                    };
                    window.parent.postMessage(identity, evt.origin);
                    break;
            }
        }

        if (window.addEventListener) {
            window.addEventListener('message', messageHandler, false);
        } else {
            window.attachEvent('onmessage', messageHandler);
        }

        // Iframe JavaScript is loaded, send READY message to parent
        var iframeReady = {
            version: 1,
            type: 'DigiTrust.iframe.ready',
            value: {}
        };
        window.parent.postMessage(iframeReady, document.referrer);

    </script>
</head>
</html>